- name: Pre-Migration Checks
  hosts: migrator
  connection: local
  gather_facts: true

  vars:
    repo_root: "{{ playbook_dir | dirname }}"
    modules_root: "{{ repo_root }}/plugins/modules"
    source_root: "{{ modules_root }}/src"

  tasks:
    - name: List all Go module directories
      ansible.builtin.find:
        paths: "{{ source_root }}"
        file_type: directory
        recurse: no
      register: src_contents
      no_log: true

    - name: Extract Go module names
      ansible.builtin.set_fact:
        go_modules: "{{ src_contents.files | map(attribute='path') | map('basename') | list }}"

    - name: Verify compiled Go binaries exist
      ansible.builtin.stat:
        path: "{{ modules_root }}/{{ item }}"
      register: binary_status
      loop: "{{ go_modules }}"
      no_log: true

    - name: Fail if any compiled Go binary is missing
      ansible.builtin.fail:
        msg: "ERROR: Missing compiled Go binaries: {{ missing_modules | join(', ') }}. Please compile them."
      vars:
        missing_modules: >-
          {{ binary_status.results
             | selectattr('stat.exists', 'equalto', false)
             | map(attribute='item')
             | list }}
      when: missing_modules | length > 0

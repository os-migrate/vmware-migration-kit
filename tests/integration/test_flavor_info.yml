- hosts: localhost
  gather_facts: no
  vars:
    go_server_path: tests/integration/fake/openstack/srv.go

  tasks:
    - name: Start fake OpenStack server asynchronously
      ansible.builtin.command: go run "{{ go_server_path }}"
      async: 10
      poll: 0
      register: fake_server_job

    - name: Wait for server URL to appear
      ansible.builtin.pause:
        seconds: 2

    - name: Get the actual server URL from stdout
      ansible.builtin.shell: "ps aux | grep fake_server/main.go | grep -v grep | head -1 | awk '{print $11}'"
      register: fake_os_url
      changed_when: false

    - ansible.builtin.debug:
        msg: "Fake OpenStack URL is {{ fake_os_url.stdout }}"

    - name: Call flavor_info against fake OpenStack
      os_migrate.vmware_migration_kit.flavor_info:
        cloud:
          AuthURL: "{{ fake_os_url.stdout }}/v3"
          Username: demo-user
          Password: password
          ProjectID: demo-id
          ProjectName: demo
          UserDomainName: default
          RegionName: RegionOne
        flavor_name: "small"
      register: flavor_info

    - ansible.builtin.debug:
        var: flavor_info
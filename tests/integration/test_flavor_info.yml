# todo/ideas
# - divide structure into: setup, running scenarios, cleanup
# - tests: finding by id, listing all flavour, non existing flavours
# - error conditions, failed auth, conection, maybe case sensitivity and special chars
- name: Integration tests for flavor_info module against mock OpenStack
  hosts: localhost
  gather_facts: false
  vars:
  #  Path to the fake OpenStack server implementation
    go_server_path: tests/integration/fake/openstack/srv.go
    server_url_file: /tmp/fake_os_url.txt
    server_pid_file: /tmp/fake_os_server.pid

  tasks:
# SETUP FOR FAKE SERVER
    - name: Start fake OpenStack server asynchronously
      ansible.builtin.command: go run "{{ go_server_path }}"
      args:
        creates: "{{ server_pid_file }}"
      async: 30
      poll: 0
      register: fake_server_job

    - name: Wait for the server URL file to be created
      ansible.builtin.wait_for:
        path: "{{ server_url_file }}"
        state: present
        timeout: 10

    - name: Read the server URL from the file
      ansible.builtin.slurp:
        src: "{{ server_url_file }}"
      register: fake_os_url_b64
      failed_when: fake_os_url_b64.rc != 0

    - name: Set the server URL fact
      ansible.builtin.set_fact:
        fake_os_url: "{{ fake_os_url_b64['content'] | b64decode }}"

    - name: Read the server PID from the file
      ansible.builtin.slurp:
        src: "{{ server_pid_file }}"
      register: fake_os_pid_b64
      failed_when: fake_os_pid_b64.rc != 0

    - name: Set the server PID fact
      ansible.builtin.set_fact:
        fake_os_pid: "{{ fake_os_pid_b64['content'] | b64decode }}"

# TESTS SCENARIOS WIP/todo

    - name: Run test scenarios
      block:
        - name: "TEST01: find flavor by name"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST02: find flavor by ID"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST03: list all flavors"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST04: non-existent flavor by name"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST05: invalid credentials"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST06: empty flavor name"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST07: verify flavor properties"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST08: loop through multiple flavors"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST09: verify detailed flavor properties"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST10: case sensitivity test"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST11: special characters in flavor name"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST12: connection failure"
          ansible.builtin.debug:
            msg: "TODO"
        - name: "TEST13: all flavour with pagination"
          ansible.builtin.debug:
            msg: "TODO"

# CLEANUP

      always:
        - name: Stop fake OpenStack server
          ansible.builtin.command: "kill {{ fake_os_pid }}"
          changed_when: true
          failed_when: false

        - name: Clean URL and PID files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ server_url_file }}"
            - "{{ server_pid_file }}"
